\usepackage{etoolbox}

\PassOptionsToPackage{HTML}{xcolor}
%\usepackage[HTML]{xcolor} % must occur before qrcode in apex_style
\usepackage{tikz}
\usetikzlibrary{calc}

% with 10pt font, 1em ~ 10pt ; 1ex ~ 4.3pt

%%Page Size stuff

\usepackage[paperheight=11in,paperwidth=8.5in,%
	inner=1in,textheight=7in,textwidth=320pt,marginparwidth=150pt,%
	marginparsep=32pt,bottom=3in,footskip=1.5in]{geometry}

\newcommand{\exercisegeometry}{%
%	\batchmode%
	\newgeometry{inner=72pt,outer=72pt,textheight=9.25in,tmargin=.75in,
		marginparwidth=150pt,marginparsep=32pt,footskip=29pt}%
%	\errorstopmode%
}
\newcommand{\eendgeometry}{%
%	\batchmode%
	\newgeometry{inner=72pt,outer=36pt,textheight=10in,
		marginparwidth=150pt,marginparsep=32pt}%
%	\errorstopmode%
}
\newcommand{\prefacegeometry}{%
%	\batchmode%
	\newgeometry{inner=1in,textheight=9in,textwidth=320pt,marginparwidth=150pt,%
		marginparsep=32pt,bottom=1in,footskip=1.5in}%
%	\errorstopmode%
}

%%% This was originally a style with \usepackage, but inputing is generally
%%% equivalent.  The only real difference is how latexml handles style files.
%%% So we'll input this document as a header instead,
%%% and save \usepackage{customstyle}
%%% for things latexml is having trouble with.
%%% This does mean that the distinction between APEX_format and Header_Calculus
%%% is no longer important, and mostly historical.

% do we want to print the keys for the labels? if so, uncomment
%\usepackage[notref,notcite]{showkeys}

\usepackage{amsmath}
\usepackage{amssymb} % todo ? https://tex.stackexchange.com/a/3000/107497 recommends dropping amssymb in favor of unicode-math
% but then the font loading gets messed up with mathspec
% see also https://tex.stackexchange.com/q/218112/107497 that if the font doesn't have math, then it's a losing battle
%\RequirePackage{unicode-math}

\usepackage{graphicx}
\usepackage{multicol}
\usepackage{makeidx}

\usepackage[normalem]{ulem}

\usepackage{calc}
\usepackage{ragged2e}

\usepackage[inline]{enumitem}

\usepackage[nocomments]{latexml}
\lxDocumentID{apex}

\numberwithin{figure}{section}
\numberwithin{equation}{section}

\usepackage{amsthm}

\newtheoremstyle{apexExample}% name
  {0pt}% Space above, empty = `usual value'
  {0pt}% Space below
  {}% Body font
  {}% Indent amount (empty = no indent, \parindent = para indent)
  {\bfseries}% Thm head font
  {}% Punctuation after thm head
  {\newline}% Space after thm head
  {\parbox[t]{8em}{\bfseries\thmname{#1} \thmnumber{#2}}%
   \thmnote{\parbox[t]{.75\textwidth}{\bfseries\raggedright#3}}%
  }

\newtheoremstyle{apex}% name
  {0pt}% Space above, empty = `usual value'
  {0pt}% Space below
  {}% Body font
  {}% Indent amount (empty = no indent, \parindent = para indent)
  {\bfseries}% Thm head font
  {}% Punctuation after thm head
  {\newline}% Space after thm head
  {\parbox[t]{8em}{\bfseries\thmname{#1} \thmnumber{#2}}%
   \thmnote{\parbox[t]{.7\textwidth}{\bfseries\raggedright#3}}%
  }% Thm head spec
  % the padding for the box takes just a bit of room away from these that examples get to keep

\theoremstyle{apexExample}
\newtheorem{example}{Example}[section]
\newcommand{\exampleautorefname}{Example}
\theoremstyle{apex}


\makeatletter
\renewenvironment{proof}[1][\proofname]{\pagebreak[2]\par
  \pushQED{\qed}%
  \normalfont \topsep6\p@\@plus6\p@\relax
  \trivlist
  \item[\hskip\labelsep
        \bfseries
    #1]\mbox{}\\* % something is needed to be able to get a newline
}{%
  \popQED\endtrivlist\@endpefalse
}
\makeatother
\renewcommand{\qedsymbol}{\ensuremath{\square}}


\makeindex

\newcommand{\apex}{\texorpdfstring{A\kern -.1em \lower -.5ex\hbox{P}\kern -.25em\lower .5ex\hbox{E}\kern -.1em X}{APEX}}


% Create boolean for whether or not to print 3D graphics. 
% Also creates command to switch back and forth; "looks better."
\newtoggle{in_threeD}
\newcommand{\usethreeDgraphics}{\toggletrue{in_threeD}}
\newcommand{\usetwoDgraphics}{\togglefalse{in_threeD}}
\usethreeDgraphics


\usepackage{pgfplots}
\pgfplotsset{compat=1.8}

\newtoggle{inColor}
\toggletrue{inColor}

\pgfplotsset{colormap={coloronemap}{rgb=(.4,.4,1); rgb=(.8,.8,1)}}
\pgfplotsset{colormap={colortwomap}{rgb=(1,.4,.4); rgb=(1,.8,.8)}}
%\usepgfplotslibrary{external}
% only needed for external tikz pictures (and not liked by latexml)
% see http://tex.stackexchange.com/a/1475/107497
\usetikzlibrary{calc}
\usetikzlibrary{shadings}

% these will be renewcommanded
\newcommand{\colorone}{blue}
\newcommand{\colortwo}{red}
\newcommand{\colorthree}{green}
\newcommand{\coloronefill}{blue!15!white}
\newcommand{\colortwofill}{red!15!white}
\newcommand{\colormapone}{rgb=(.4,.4,1); rgb=(.8,.8,1)}
\newcommand{\colormaptwo}{rgb=(1,.4,.4); rgb=(1,.8,.8)}
\newcommand{\colormapplaneone}{rgb=(.7,.7,1); rgb=(.9,.9,1)}
%\definecolor{colormaponebottom}{rgb}{.4,.4,1}
%\definecolor{colormaponetop}{rgb}{.8,.8,1}
%\definecolor{colormaptwobottom}{rgb}{1,.4,.4}
%\definecolor{colormaptwotop}{rgb}{1,.8,.8}

% determines the line colors for color and black and white lines.
\newcommand{\colorlinecolor}{blue!95!black!30}
\newcommand{\bwlinecolor}{black!30}

% sets the line color to be in color, as a default
\newcommand{\thelinecolor}{\colorlinecolor}

% this allows the above default to be overriden by using
% the \printincolor and \printinblackandwhite commands
% anywhere in the file. This allows you to switch back
% and forth between bw and color. (Who would want to?)
\newcommand{\colornamesuffix}{}

\newcommand{\printincolor}{
 \toggletrue{inColor}%
 % aforementioned renewcommanding
 \renewcommand{\thelinecolor}{\colorlinecolor}
 \renewcommand{\colornamesuffix}{}
 \renewcommand{\colorone}{blue}
 \renewcommand{\colortwo}{red}
 \renewcommand{\colorthree}{green}
 \renewcommand{\coloronefill}{blue!15!white}
 \renewcommand{\colortwofill}{red!15!white}
 \renewcommand{\colormapone}{rgb=(.4,.4,1); rgb=(.8,.8,1)}
 \renewcommand{\colormaptwo}{rgb=(1,.4,.4); rgb=(1,.8,.8)}
 \renewcommand{\colormapplaneone}{rgb=(.7,.7,1); rgb=(.9,.9,1)}
 \definecolor{colormaponebottom}{rgb}{.4,.4,1}
 \definecolor{colormaponetop}{rgb}{.8,.8,1}
 \definecolor{colormaptwobottom}{rgb}{1,.4,.4}
 \definecolor{colormaptwotop}{rgb}{1,.8,.8}
 \setexvideocolor
 \colorizespecialboxes
}

\newcommand{\printinblackandwhite}{
 \togglefalse{inColor}%
 % undoing the above renewcommanding
 \renewcommand{\thelinecolor}{\bwlinecolor}
 \renewcommand{\colornamesuffix}{BW}
 \renewcommand{\colorone}{black}
 \renewcommand{\colortwo}{black!50!white}
 \renewcommand{\colorthree}{black!25!white}
 \renewcommand{\coloronefill}{black!15!white}
 \renewcommand{\colortwofill}{black!05!white}
 \renewcommand{\colormapone}{rgb=(.4,.4,.4); rgb=(.7,.7,.7)}
 \renewcommand{\colormaptwo}{rgb=(.6,.6,.6); rgb=(.9,.9,.9)}
 \renewcommand{\colormapplaneone}{rgb=(.8,.8,.8); rgb=(.95,.95,.95)}
 \definecolor{colormaponebottom}{rgb}{.4,.4,.4}
 \definecolor{colormaponetop}{rgb}{.7,.7,.7}
 \definecolor{colormaptwobottom}{rgb}{.6,.6,.6}
 \definecolor{colormaptwotop}{rgb}{.9,.9,.9}
 \setexvideobw
 \bwizespecialboxes
}


\newcommand{\myincludegraphics}[2][]{%
 \IfFileExists{./#2\colornamesuffix.png}{%
  \includegraphics[#1]{#2\colornamesuffix.png}%
 }{%
  \IfFileExists{./#2.png}{%
   \includegraphics[#1]{#2.png}%
  }{%
   \IfFileExists{./#2\colornamesuffix.pdf}{%
    \includegraphics[#1]{#2\colornamesuffix.pdf}%
   }{%
    \IfFileExists{./#2.pdf}{%
     \includegraphics[#1]{#2.pdf}%
    }{%
     \includegraphics[#1]{#2\colornamesuffix}%
    }%
   }%
  }%
 }%
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Examples
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newlength{\boxskipamount}
\setlength{\boxskipamount}{4ex plus 4ex minus 2ex}

%\newlength{\topmarginlength} 
%\newlength{\bottommarginlength}
%\newlength{\oddpagemarginlength}
%\newlength{\evenpagemarginlength}
\newlength{\marginlinelength}
%\newlength{\innerpagemarginlength}

% how far from the text the example line is to be drawn
\setlength{\marginlinelength}{.2em}

% the height of the top margin (used in calculating the lines for examples)
%\setlength{\topmarginlength}{-1in-\voffset}

% the length of the bottom margin (ish)
% actually starts at the top of the page, moves
% through the top margin length then the text height.
%\setlength{\bottommarginlength}{-1in-\textheight-2\baselineskip-\voffset-\headheight-\headsep-\topmargin}

% the length of the left hand margin of an odd page
%\setlength{\oddpagemarginlength}{1in+\hoffset+\oddsidemargin-2\marginlinelength}

% the length of the left hand margin of an even page
%\setlength{\evenpagemarginlength}{1in+\hoffset+\evensidemargin-2\marginlinelength}

\newcommand{\solution}{\bigbreak\par
 \makebox[6.5em][l]{\textsc{\small\textbf{Solution\lxAddClass{solutionTag}}}}%
 \nopagebreak%
}

% black: hsl(x,x,0)
% white: hsl(x,x,100)
% blue: hsl(240,100,50)
% line color: blue!95!black!30 = Hsb(240,.29,.98) = hsl(240,87.7,83.8)

\usepackage{tcolorbox}
\tcbuselibrary{breakable,skins,theorems}

\newlength{\saveparindent}
\setlength{\saveparindent}{\parindent}

\tcolorboxenvironment{example}{
    empty,
    size=minimal,
    breakable,
    parbox=false,
    beforeafter skip=\boxskipamount,
    enlargepage flexible=3\baselineskip,
    lines before break=5,
    before upper={\setlength{\parindent}{\saveparindent}\noindent},
    boxsep=0pt,
    bottom=.5ex,
    overlay unbroken={
     \node[xshift=-2\marginlinelength,yshift=-.5\baselineskip]
      (start\arabic{example})at(frame.north west){};
     \node[xshift=1em](stop\arabic{example})at(frame.south west){};
     \draw[thick,\thelinecolor](start\arabic{example})|-(stop\arabic{example});
    },
    overlay first={
     \node[xshift=-2\marginlinelength,yshift=-.5\baselineskip]
      (start\arabic{example})at(frame.north west){};
     \node[xshift=-2\marginlinelength,yshift=-2\baselineskip]
      (stop\arabic{example})at(frame.south west){};
     \draw[thick,\thelinecolor](start\arabic{example})--(stop\arabic{example});
    },
    overlay middle={
     % a middle has only one on a page, so we don't need other suffixes
     \node[xshift=-2\marginlinelength,yshift=.5\baselineskip]
      (start)at(frame.north west){};
     \node[xshift=-2\marginlinelength,yshift=-2\baselineskip]
      (stop)at(frame.south west){};
     \draw[thick,\thelinecolor](start)--(start|-stop);
    },
    overlay last={
     \node[xshift=-2\marginlinelength,yshift=.5\baselineskip]
      (start\arabic{example})at(frame.north west){};
     \node[xshift=1em](stop\arabic{example})at(frame.south west){};
     \draw[thick,\thelinecolor](start\arabic{example})|-(stop\arabic{example});
    },
}

% large shrinkable space can conspire with a bad page break to cause text to overlap
% see https://tex.stackexchange.com/a/551585/107497 by Thomas F. Sturm
\makeatletter
\def\tcb@split@force@last{%
  \tcb@split@setstate@last%
  \ifdim\tcb@h@total>\tcb@h@page\relax%
    \gdef\tcb@after@lastbox{\clearpage}%
    \tcbdimto\kvtcb@bbbottom{\kvtcb@bbbottom+\tcb@h@page-\tcb@h@total}%
  \fi%
}
\makeatother



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Definitions, Theorems and Key Ideas
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\newspecialbox}[3]{%
 \AtBeginDocument{\makeStyles{#1}{#3}}%
 \expandafter\newcommand\csname colorize#1\endcsname{
  \definecolor{top#1}{Hsb}{#3,.05,1}% = hsl(#4,100,97.5)
  \ifnumequal{#3}{60}{%
   \definecolor{border#1}{Hsb}{#3,.59,.97}% = hsl(#4,90.5,68.4)
   \definecolor{bottom#1}{Hsb}{#3,.28,.97}% = hsl(#4,81.9,83.4)
  }{%
   \definecolor{border#1}{Hsb}{#3,.23,.65}% = hsl(#4,17.6,57.5)
   \definecolor{bottom#1}{Hsb}{#3,.13,.92}% = hsl(#4,42.8,86)
  }%
 }
 \expandafter\newcommand\csname bwize#1\endcsname{
  \colorlet{top#1}{white}
  \colorlet{bottom#1}{white}
  \colorlet{border#1}{black}
 }
 \newtheorem{#1}{#2}[section]%
 \expandafter\newcommand\csname #1autorefname\endcsname{#2}
 \tcolorboxenvironment{#1}{
   sharp corners=all,
   enhanced,
   colframe=border#1,
   beforeafter skip=\boxskipamount,
   interior style={top color=top#1, bottom color=bottom#1},
   breakable=true,
   overlay first={\continue{bottom}{#1}},
   overlay middle={\continue{bottom}{#1}\continue{top}{#1}},
   overlay last={\continue{top}{#1}},
   enlargepage flexible=3\baselineskip,
   toggle enlargement=evenpage,
   lines before break=8,
 }
}

\newcommand{\continue}[1]{%
 \csname continue#1\endcsname{#1}%
}
\newcommand{\continuetext}[2]{%
 \ifstrequal{#1}{top}{%
  \csname #2autorefname\endcsname\ \csname the#2\endcsname\ continued%
 }{%
  (continued)
 }%
}
% can't get this to work
%\newcommand{\northsouth}[2][]{\if thenelse{\equal{#2}{top}}{#1north}{#1south}}

% adapted from https://tex.stackexchange.com/a/545324/107497 by SchrÃ¶dinger's cat
\newcommand{\continuebottom}[2]{
   \path[font=\small\itshape] (frame.south) node (cont) {\continuetext{#1}{#2}};
   \begin{scope}[decoration={zigzag,amplitude=0.5mm}]
    \path[fill=#1#2]
     decorate {([xshift= 1.2pt]frame.south west) -- (cont.west)} --++ (0,0.5ex)
      -| cycle
     decorate {([xshift=-1.2pt]frame.south east) -- (cont.east)} --++ (0,0.5ex)
      -| cycle;
    \path[fill=white]
     decorate {([xshift= 1.2pt]frame.south west) -- (cont.west)} --++ (0,-0.5ex)
      -| cycle
     decorate {([xshift=-1.2pt]frame.south east) -- (cont.east)} --++ (0,-0.5ex)
      -| cycle;
   \end{scope} 
}
\newcommand{\continuetop}[2]{
   \path[font=\small\itshape] (frame.north) node (thm) {\continuetext{#1}{#2}};
   \begin{scope}[decoration={zigzag,amplitude=0.5mm}]
    \path[fill=#1#2]
     decorate {([xshift= 1.2pt]frame.north west) -- (thm.west)} --++ (0,-0.5ex)
      -| cycle
     decorate {([xshift=-1.2pt]frame.north east) -- (thm.east)} --++ (0,-0.5ex)
      -| cycle;
    \path[fill=white]
     decorate {([xshift= 1.2pt]frame.north west) -- (thm.west)} --++ (0,0.5ex)
      -| cycle
     decorate {([xshift=-1.2pt]frame.north east) -- (thm.east)} --++ (0,0.5ex)
      -| cycle;
   \end{scope} 
}

\newspecialbox{definition}{Def\-i\-ni\-tion}{60}
% draw = yellow!95!black!60 = Hsb( 60,.59,.97)
% topc = white!95!yellow    = Hsb( 60,.05,1)
% botc = yellow!90!black!30 = Hsb( 60,.28,.97)

\newspecialbox{theorem}{The\-o\-rem}{120}
% draw = green!30!black!50  = Hsb(120,.23,.65)
% topc = white!95!green     = Hsb(120,.05,1)
% botc = green!60!black!20  = Hsb(120,.13,.92)

\newspecialbox{keyidea}{Key I\-dea}{0}
% draw = red!30!black!50    = Hsb(  0,.23,.65)
% topc = white!95!red       = Hsb(  0,.05,1)
% botc = red!60!black!20    = Hsb(  0,.13,.92)

\newcommand{\colorizespecialboxes}{
 \colorizedefinition
 \colorizetheorem
 \colorizekeyidea
}
\newcommand{\bwizespecialboxes}{
 \bwizedefinition
 \bwizetheorem
 \bwizekeyidea
}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Exercises
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setlength{\columnsep}{20pt}

\makeatletter
\newcommand{\exercisesubsubsection}{%
 \closeenumerate%
 \@startsection{subsubsection}{3}{-1em}{\bigskipamount}{\bigskipamount}{\Large\textit}*}
\makeatother

\newcommand{\printconcepts}{\exercisesubsubsection{Terms and Concepts}}
\newcommand{\printproblems}{\exercisesubsubsection{Problems}}
\newcommand{\printreview}{\exercisesubsubsection{Review}}

\newcommand{\inanswersection}{%
	\renewcommand{\printconcepts}{}%
	\renewcommand{\printproblems}{}%
	\renewcommand{\printreview}{}%
	\renewenvironment{exerciseset}[2]{}{}
	\renewcommand{\openenumerate}{}%
	\renewcommand{\closeenumerateinquestions}{}
	\renewcommand{\questioncolumnbreak}{}%
	\packageinanswersection%
	\showexerciseanswers%
}%

\newtoggle{printoddanswersonly}

\toggletrue{printoddanswersonly}
\newcommand{\printallanswers}{\togglefalse{printoddanswersonly}}

%\newcount\numberofexercises


\newwrite\answrite %write the answers file
% give the answers file the name ``jobname.answers''
\openout\answrite=\jobname.answers

% \writeToAnsFile (was?) in the style file b/c latexml was copying in ``noexpand''
\newcommand{\writeToAnsFile}[1]{%
 \immediate\write\answrite{%
  \noexpand\answersForSection{\arabic{chapter}}{\arabic{section}}{#1}%
 }%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Answers
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\printsolutions}[2][\jobname]{%
 %\showans\answrite
 % showans will write the contents of Calculus.answers to the log
 % in latexml, this needs to happen before closing
 \immediate\closeout\answrite%
 \inanswersection\exercisegeometry%
 \pagestyle{exercise}%
 %\thispagestyle{empty}%
 \ifstrequal{#1}{\jobname}{}{%
  {% localize the next line
   \renewcommand{\thefootnote}{}
   \chapter*{#2\footnote{Revised \today}}%
  }%
 }%
 \addcontentsline{toc}{chapter}{#2}%
 \begin{multicols}{2}%
  \small\raggedright%
  \input{#1.answers}%
 \end{multicols}%
 \restoregeometry\pagestyle{prose}%
 \setlength{\hoffset}{0pt}\rmfamily%
 \pagestyle{empty}%
 \eendgeometry%
}%

\newcounter{exercisesetcounter}[section]
\renewcommand{\theexercisesetcounter}{\thesection.\arabic{exercisesetcounter}}

\makeatletter
% the usual \subsection definition has stretchable space in arguments 3-5
\newcommand{\exercisesubsection}[1]{%
\@startsection{subsection}{2}{-.7em}{0pt}{.5ex}{\huge\textbf}{\texorpdfstring{\hyperref[sol#1]{Exercises #1}}{Exercises}}%
\hrule\vspace{-1.5ex}%
}
\makeatother

\newcommand{\exautoref}[1]{%
 \hyperref[#1]{Ex\-er\-cise~\ref*{#1}}%
% {%
%  \renewcommand{\Itemautorefname}{Exercise}% localize the upcoming reference
%  \autoref{#1}%
% }%
% doesn't work?
}

\newcommand{\printexercises}[1]{%
 \writeToAnsFile{#1}% writeToAnsFile in sty
 \exercisegeometry% includes a clearpage
 \pagestyle{exercise}%
 \exercisesubsection{\thesection}%
 \label{exer\thesection}%
 \small%
 \bigskip%
 \begin{multicols}{2}%
  \restartlist{enumerate}
  \setcounter{enumi}{0}
  \renewcommand{\Itemautorefname}{Ex\-er\-cise}% local b/c multicols = good
  \input{#1}%
  \closeenumerate%
 \end{multicols}%
 \restoregeometry%
 \pagestyle{prose}%
 %	\easypagecheck
 \setlength{\hoffset}{0pt} \rmfamily\normalsize \bigbreak%
}

%\newcounter{answerchapter}
%\newcounter{answersection}[answerchapter]
%\renewcommand{\theanswersection}{\theanswerchapter.\arabic{answersection}}
\newcommand{\lastanswerchapter}{-1}

\newcommand*{\answersForSection}[3]{%
 \ifnumequal{#1}{\lastanswerchapter}{}{%
  \renewcommand{\lastanswerchapter}{#1}% apparently global. who knew?
  \ifbool{latexml}{}{%
   \belowpdfbookmark{Chapter #1}{solsol#1}%
  }
  % commandeer chapter and section numbering
  \setcounter{chapter}{#1}
  \section*{Chapter \thechapter}
 }%
 \setcounter{section}{#2}
 \subsection*{\hyperref[exer\thesection]{Exercises \thesection}}%
 \label{sol\thesection}
 \ifnumequal{#2}{0}{%
  \loadAllAnswers{#3}
 }{%
  \loadAnswers{#3}
 }%
}

% only called by the prerequisite sections
\newcommand*{\loadAllAnswers}[1]{%
%	\setcounter{answersection}{-1}%
	\iftoggle{printoddanswersonly}{%
		\togglefalse{printoddanswersonly}%
		\loadAnswers{#1}%
		\toggletrue{printoddanswersonly}%
	}{%
		\loadAnswers{#1}%
	}%
}
\newcommand*{\loadAnswers}[1]{%
%	\stepcounter{answersection}%
	\begin{enumerate}[leftmargin=1.5em]\input{#1}\end{enumerate}%
	\bigbreak%
}

\newcommand*{\enumenv}{enumerate}

\makeatletter
\newcommand{\openenumerate}{%
 \ifx\@currenvir\enumenv\else%
 \begin{enumerate}[leftmargin=1.5em,resume=exercises\thesection]%
 \fi%
}
\newcommand{\closeenumerate}{
 \ifx\@currenvir\enumenv%
 \end{enumerate}%
 \fi%
}
\makeatother
\newcommand{\closeenumerateinquestions}{\closeenumerate}

\newenvironment{exerciseset}[2]{%
 \stepcounter{enumi}%
 \stepcounter{exercisesetcounter}%
 \ifnumodd{\value{enumi}}{}{%
  \PackageInfo{apex}{%
   Exercise set \theexercisesetcounter\space begins with \arabic{enumi}%
  }%
 }%
 \pagebreak[1]%
 {%
 \setlist[enumerate,1]{label=(\alph*)}%
 \noindent#1 \arabic{enumi}--\ref*{enumiatendof\theexercisesetcounter}#2%
 }%
 \addtocounter{enumi}{-1}\ignorespaces%
 \nopagebreak%
}{%
 \label{enumiatendof\theexercisesetcounter}%
 \closeenumerate%
 \pagebreak[1]%
 \ifnumodd{\value{enumi}}{%
  \PackageInfo{apex}{%
   Exercise set \theexercisesetcounter\space ends with \arabic{enumi}%
  }%
 }{}%
}
\BeforeBeginEnvironment{exerciseset}{\closeenumerateinquestions}

\newcommand{\exercise}[2]{%
 \openenumerate%
 \item \parbox[t]{\linewidth}{#1}%
}
\newcommand{\showexerciseanswers}{%
 \renewcommand{\exercise}[2]{%
  \ifboolexpr{ togl{printoddanswersonly} and test{\ifnumodd{\value{enumi}}} }{%
   \stepcounter{enumi}%
  }{%
   \item \parbox[t]{\linewidth}{\raggedright ##2}%
  }%
 }%
}

\newcommand{\questioncolumnbreak}{\columnbreak}


% The following creates a ``List of Theorems'', ``Definitions'', and ``Key Ideas''.
% See http://tex.stackexchange.com/q/74857/107497
%\usepackage{thmtools} % continuing theorems and ``List of Theorems''
%\patchcmd\thmtlo@chaptervspacehack
%  {\addtocontents{loe}{\protect\addvspace{10\p@}}}
%  {\addtocontents{loe}{\protect\thmlopatch@endchapter\protect\thmlopatch@chapter{\thechapter}}}
%  {}{failed thmtlo@chaptervspacehack}
%\AtEndDocument{\addtocontents{loe}{\protect\thmlopatch@endchapter}}
%\long\def\thmlopatch@chapter#1#2\thmlopatch@endchapter{%
%  \setbox\z@=\vbox{#2}%
%  \ifdim\ht\z@>\z@
%    \hbox{\bfseries\chaptername\ #1}\nobreak
%    #2
%    \addvspace{10\p@}
%  \fi
%}
%\def\thmlopatch@endchapter{}
%\patchcmd\thmt@mklistcmd
%  {\protect\numberline{\csname the\thmt@envname\endcsname}%
%      \thmt@thmname}{}{}{failed thmt@mklistcmd}
%%\makeatother
%\renewcommand\thmtformatoptarg[1]{#1}

