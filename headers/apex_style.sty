\RequirePackage{pst-fun} % for psBill in 14_Stokes

% required only for what happens in this file
\RequirePackage{changepage}
\RequirePackage[inline]{enumitem}
\RequirePackage{layout}
\RequirePackage[h]{esvect}
\RequirePackage[noplaybutton]{media9} % for embedding 3d images
\RequirePackage{qrcode}
\RequirePackage{everypage} % helps put the blue example line on long examples
%\RequirePackage{thmtools} % continuing theorems and ``List of Theorems''
%\usepackage{lipsum} % not used

% The following helps create a ``List of Theorems'', ``Definitions'', and ``Key Ideas''.  See http://tex.stackexchange.com/q/74857/107497
%\usepackage{etoolbox}
%\patchcmd\thmtlo@chaptervspacehack
%  {\addtocontents{loe}{\protect\addvspace{10\p@}}}
%  {\addtocontents{loe}{\protect\thmlopatch@endchapter\protect\thmlopatch@chapter{\thechapter}}}
%  {}{failed thmtlo@chaptervspacehack}
%\AtEndDocument{\addtocontents{loe}{\protect\thmlopatch@endchapter}}
%\long\def\thmlopatch@chapter#1#2\thmlopatch@endchapter{%
%  \setbox\z@=\vbox{#2}%
%  \ifdim\ht\z@>\z@
%    \hbox{\bfseries\chaptername\ #1}\nobreak
%    #2
%    \addvspace{10\p@}
%  \fi
%}
%\def\thmlopatch@endchapter{}
%\patchcmd\thmt@mklistcmd
%  {\protect\numberline{\csname the\thmt@envname\endcsname}%
%      \thmt@thmname}{}{}{failed thmt@mklistcmd}
%%\makeatother
%\renewcommand\thmtformatoptarg[1]{#1}

\newcommand{\embedVideo}[1]{}
%\def \embedVideo#1{\fbox{%
%  \includemedia[%
%    width=.96\linewidth,%
%    height=0.54\linewidth,% 16:9
%    activate=pageopen,%
%    flashvars={%
%      modestbranding=1% no YT logo in control bar
%     &autohide=1% controlbar autohide
%     &showinfo=0% no title and other info before start
%     &rel=0% no related videos after end
%    }%
%   ]{%
%    %\href{https://www.youtube.com/v/#1?rel=0}{#1}% alt text
%   }{%
%    #1%https://www.youtube.com/v/#1?rel=0%
%   }%
%}}

\newcommand{\iframe}[3]{}

\newcommand{\makeStyles}[2]{} % only in .ltxml

\newcommand{\coloredbox}[3]{%
\noindent%
\begin{tikzpicture}%
\ifthenelse{\boolean{inColor}}%
{\draw (0,0) node[#1] {#3};}% was (\specialboxtitlelength,0)
{\draw (0,0) node[#2] {#3};}% ditto
\end{tikzpicture}%
}


%%%%%%%%% the line to the left of examples

% creates a generic style for the lines. You can add lots
% of things here, all separated by commas.
\newcommand{\linestyle}{[thick, \thelinecolor]}

\newcommand{\setlinestyle}[1]{\renewcommand{\linestyle}{[#1, \thelinecolor]}}

% Do you want to draw the blue lines for examples?
\newboolean{showexamplelines}
\setboolean{showexamplelines}{true}
%\setboolean{showexamplelines}{false}

\newcommand*{\currentExampleLabel}{\undefined}

\newboolean{eoeencountered}
\newcommand{\currentLabel}{notinexample}

% thanks to Steven B. Segletes and egreg at
% http://tex.stackexchange.com/a/320586/107497
\newcommand{\eoehere}{%
 \ifthenelse{\boolean{eoeencountered}}{%
  \vspace{-\baselineskip}\nopagebreak%
 }{%
  \drawnode{e\currentLabel}{0}{0}%
  \ltx@label{e\currentLabel}%
 % \gdef\currentLabel{notinexample}%
  \ifthenelse{\boolean{measuring@}}{}{\global\eoeencounteredtrue}%
 }%
}

\newcounter{pagebeforeend}

\newcommand{\examplestarred}[3]{%
%\stepcounter{examplecounter}%
\setboolean{eoeencountered}{false}%
\renewcommand{\currentLabel}{#1}%
\bigbreak%
\noindent%
\begin{exampleEnv}[#2]\label{#1}%
 \drawnode{#1}{-2\marginlinelength}{\baselineskip}%
 \ifthenelse{\pageref{#1}=\pageref{e#1}}{}{%
  % if different pages, we need to draw start to bottom before leaving the page
  \ifthenelse{\boolean{showexamplelines}}{%
   \begin{tikzpicture}[remember picture,overlay]%
    \node [yshift=\bottommarginlength](bottom) at (current page.north) {};%
    \draw \linestyle (#1) -- ( #1 |- bottom);% from start to bottom of page
   \end{tikzpicture}%
  }{}%
 }%
 \noindent%
 #3%
 \eoehere%
 \ifthenelse{\boolean{showexamplelines}}{%
  \ifthenelse{\pageref{#1}=\pageref{e#1}}{%
   \begin{tikzpicture}[remember picture,overlay]
    \drawexampleend{#1}{#1}
   \end{tikzpicture}%
  }{% if different pages (start to bottom already happened)
   \ifthenelse{\isodd{\pageref{e#1}}}{
    \setlength{\innerpagemarginlength}{\oddpagemarginlength}
   }{
    \setlength{\innerpagemarginlength}{\evenpagemarginlength}
   }
   \begin{tikzpicture}[remember picture,overlay]
    \node [xshift=\innerpagemarginlength,yshift=\topmarginlength](topleft) at (current page.north west)  {};
    \drawexampleend{topleft}{#1}
   \end{tikzpicture}%
   \setcounter{pagebeforeend}{\thepage}%
   \addtocounter{pagebeforeend}{-1}%
   \ifthenelse{\pageref{#1}<\value{pagebeforeend}}{%
    \write\@auxout{\noexpand\longexample{#1}}%
   }{}% end long example
  }
 }{}% ends if example lines
\end{exampleEnv}%
\bigbreak%
}%ends the definition of examplestarred

\newcommand*{\drawexampleend}[2]{%
 \draw \linestyle (#1)--(#1 |- e#2.south) -- ++(0,-.2\baselineskip) -- ++(10pt,0);
}

\newcommand*{\drawnode}[3]{%
\parbox[l]{0pt}{%
 \ifthenelse{\boolean{showexamplelines}}{%
  \begin{tikzpicture}[remember picture,overlay]
   \draw (#2,#3) node (#1) {};
%   \draw (#2,#3) circle (1pt) node (#1) {};
%   \draw (#2,#3) circle (1pt) node (#1) {\nolinkurl{#1}};
  \end{tikzpicture}%
 }{}%
}}

\newcommand*{\longexample}[1]{
 \AddEverypageHook{%
  \ifthenelse{ \pageref{#1}<\value{page} \AND \value{page}<\pageref{e#1} \AND%
               \boolean{@mainmatter} \AND \boolean{printquestions} }{%
   \drawexampleline%
  }{%
  }%
 }%
}

% Draws a line on a page that doesn't contain either
% the beginning or end of an example.
% Takes no arguments; figures out if you 
% are on an even or odd numbered page for
% correct margin calculation
\newcommand{\drawexampleline}{%
\ifthenelse{\isodd{\thepage}}{%
 \setlength{\innerpagemarginlength}{\oddpagemarginlength}%
}{%
 \setlength{\innerpagemarginlength}{\evenpagemarginlength}%
}%
\begin{tikzpicture}[remember picture,overlay]
	\node [xshift=\innerpagemarginlength,yshift=\topmarginlength](tleft) at (current page.north west)  {};
	\draw \linestyle (tleft) -- ++(0,\bottommarginlength+1in);
\end{tikzpicture}}


\newcommand{\previousmarginpage}{-1}
\newlength\previousmarginbottom

% thanks to David Carlisle at http://tex.stackexchange.com/a/336910/107497
% the height cut offs have been empirically determined
\newcommand{\testmargintop}{%
	\strut\pdfsavepos%
	\write\@auxout{\string\testmargintopwith{\the\pdflastxpos}{\the\pdflastypos}{\thepage}}%
}
\newcommand{\testmargintopwith}[3]{%
%\PackageInfo{apex}{test margin top with on page #3: #2}%
	\ifthenelse{ #2 > 46800000 }{% 468e5
		\PackageWarningNoLine{apex}{mnote too high on page #3}%
	}{}%
	\ifthenelse{ #1 < 0 }{%
		\PackageWarningNoLine{apex}{mnote on left inner margin on page #3}%
	}{}%
	\ifthenelse{ #1 > 33000000 }{% 33e6
		\PackageWarningNoLine{apex}{mnote on right inner margin on page #3}% {: #1}%
	}{}%
	\ifthenelse{ #3 = \previousmarginpage }{%
		\ifthenelse{\lengthtest{\previousmarginbottom < #2 sp}}{%
			\PackageWarningNoLine{apex}{mnote overlaps on page #3}% {: #2}%
		}{\addtolength{\previousmarginbottom}{-2\baselineskip}%
			\ifthenelse{\lengthtest{\previousmarginbottom < #2 sp}}{%
				\PackageInfo{apex}{mnote close on page #3 (ignore line no)}%
			}{}%
		}%
	}{}%
	\global\renewcommand{\previousmarginpage}{#3}%
}
\newcommand{\testmarginbottom}{%
	\strut\pdfsavepos%
	\write\@auxout{\string\testmarginbottomwith{\the\pdflastypos}{\thepage}}%
}
\newcommand{\testmarginbottomwith}[2]{%
%\PackageInfo{apex}{testmarginbottomwith on page #2: #1}%
	\ifthenelse{ #1 < 2700000 }{% 27e5
		\PackageWarningNoLine{apex}{mnote too low on page #2}%
	}{%
		\ifthenelse{ #1 < 10000000 }{% 1e7
			\PackageInfo{apex}{mnote below Notes line on page #2 (ignore line no)}%
		}{}%
	}%
%\PackageInfo{apex}{on page #2: setting pmb to: #1}%
	\global\setlength{\previousmarginbottom}{#1 sp}%
	% 1 pt = 65536 sp = 2^16 sp
}
\AtEndDocument{\stoptestingmargins}
\newcommand{\stoptestingmargins}{%
	\renewcommand{\testmargintopwith}[2]{}%
	\renewcommand{\testmarginbottomwith}[2]{}%
}



\newcommand{\myincludeasythree}[3]{%
 \immediate\write\@auxout{\@percentchar\space prc file #3 used in Section \thesection\space as Figure \thefigure}%
 % so that Python can find it later
 \ifthenelse{\boolean{in_threeD}}{%
  \includemedia[3Dmenu,activate=onclick,deactivate=onclick,3Dlights=Headlamp,
   add3Djscript=asylabels.js,#1
  ]{\myincludegraphics{#3}}{#3\colornamesuffix.prc}%
 }{%
  \myincludegraphics[#2]{#3}%
 }}

\newcommand{\myincludegraphicsthree}{\@ifstar \myincludegraphicsthreestarred \myincludegraphicsthreenostar}

\newcommand{\myincludegraphicsthreenostar}[3]{\ifthenelse{\boolean{in_threeD}}{%
	\includemedia[#1]{\myincludegraphics{#3_3D}}{#3_3D.prc}%
}{%
	\myincludegraphics[#2]{#3}
}}

\newcommand{\myincludegraphicsthreestarred}[3]{\ifthenelse{\boolean{in_threeD}}{%
	\includemedia[#1]{\myincludegraphics{#3}}{#3_3D.prc}%
}{%
	\myincludegraphics[#2]{#3}
}}



\newcounter{flushcounter}
\newcommand{\flushinner}[1]{%
	\stepcounter{flushcounter}%
	\makebox[0pt]{\label{flushlabel\theflushcounter}}%
	\ifthenelse{\boolean{latexml}\OR\isodd{\pageref{flushlabel\theflushcounter}}}{%
%		\makebox[.99\linewidth][l]{#1}%
%		\makebox[.99\linewidth][l]{\parbox{.99\linewidth}{#1}}%
		\makebox[.99\linewidth][l]{\begin{tabular}{c}#1\end{tabular}}%
}{%
%		\makebox[.99\linewidth][r]{#1}%
%		\makebox[.99\linewidth][r]{\parbox{\textwidth}{#1}}%
		\makebox[.99\linewidth][r]{\begin{tabular}{c}#1\end{tabular}}%
	}}
\newcommand{\flushouter}[1]{%
	\stepcounter{flushcounter}%
	\makebox[0pt]{\label{flushlabel\theflushcounter}}%
	\ifthenelse{\boolean{latexml}\OR\isodd{\pageref{flushlabel\theflushcounter}}}{%
		\makebox[.99\linewidth][r]{\begin{tabular}{c}#1\end{tabular}}%
	}{%
		\makebox[.99\linewidth][l]{\begin{tabular}{c}#1\end{tabular}}%
	}}
\newcommand{\flushinnerequ}[1]{\flushinner{\vtop{#1}}}
\newcommand{\flushouterequ}[1]{\flushouter{\vtop{#1}}}


\newcommand*{\includecodegraphics}[1]{\input{#1Src}}

\newcommand*{\lxenumerate}[1]{\begin{enumerate}[#1]}



\newcommand*{\apexchapter}[3][]{%
 \clearpage\thispagestyle{empty}\cleardoublepage%
 \setboolean{chapter_already_has_exercises}{false}%
 \ifthenelse{\equal{#1}{}}{}{% else, there is a #1 argument
  % we want the ``Chapter'' heading to come after the prerequisite section
  \stepcounter{chapter}%
  \addtocounter{section}{-1}%
  \fancyhead[LE]{\chaptername\ \thechapter\ \ \ \ {#2}}%
  \let\saveaddcontentsline=\addcontentsline%
  \renewcommand{\addcontentsline}[3]{}%
  \input{#1}%
  \let\addcontentsline=\saveaddcontentsline%
  \fancyhead[LE]{\nouppercase{\leftmark}}%
  \addtocounter{chapter}{-1}%
  \setcounter{savefigure}{\value{figure}}% to avoid getting reset by \chapter
 }%
 \chapter{#2}\label{#3}%
 \thispagestyle{empty}%
 \ifthenelse{\equal{#1}{}}{}{% else, there is a #1 argument
  \setcounter{figure}{\value{savefigure}}%
 }%
}



% \mnote[offset=0]{contents}
\newcommand{\mnote}[2][0pt]{%
	\marginpar{\vspace{#1}%
		\begin{minipage}[c]{\marginparwidth}
			\captionsetup{type=figure}%
			\testmargintop%
			\mbox{}%\makebox[0pt]{\tikz\draw(0,0)circle(1pt);}%
			\\[-\baselineskip]
			#2\ifhmode\unskip\fi
			\testmarginbottom%
			%\makebox[0pt]{\tikz\draw(0,0)circle(2pt);}
		\end{minipage}%
}}



% some exercise / answer related commands

\newcommand{\writeToAnsFile}[1]{%
\ifthenelse{\boolean{chapter_already_has_exercises}}{}{% else
 \setboolean{chapter_already_has_exercises}{true}
 \immediate\write\answrite{}%
 \immediate\write\answrite{%
  \noexpand\noindent{%
   \noexpand\Large%
   \noexpand\textbf{Chapter \arabic{chapter}}%
  }%
  \noexpand\bigskip%
  \noexpand\newline%
  \noexpand\nopagebreak%
 }%
}%
\immediate\write\answrite{%
 \noexpand\noindent%
 \noexpand\hyperref[exer\thesection]{\noexpand\textbf{Exercises \thesection}}%
 \noexpand\label{sol\thesection}%
}%
\ifthenelse{\value{section}=0}{%
 \immediate\write\answrite{\noexpand\loadAllAnswers{#1}}%
}{%
 \immediate\write\answrite{\noexpand\loadAnswers{#1}}%
}%
\immediate\write\answrite{\noexpand\bigbreak}%
}
