\RequirePackage{pst-fun} % for psBill in 14_Stokes

% required only for what happens in this file
\RequirePackage{changepage}
\RequirePackage[inline]{enumitem}
\RequirePackage{layout}
\RequirePackage[h]{esvect}
\RequirePackage[noplaybutton]{media9} % for embedding 3d images
\RequirePackage{qrcode}
\RequirePackage{everypage} % helps put the blue example line on long examples
%\RequirePackage{thmtools} % continuing theorems and ``List of Theorems''
%\usepackage{lipsum} % not used

% make the space in the toc wide enough for 4 digit numbers
\renewcommand\@pnumwidth{2em}

% The following helps create a ``List of Theorems'', ``Definitions'', and ``Key Ideas''.  See http://tex.stackexchange.com/q/74857/107497
%\usepackage{etoolbox}
%\patchcmd\thmtlo@chaptervspacehack
%  {\addtocontents{loe}{\protect\addvspace{10\p@}}}
%  {\addtocontents{loe}{\protect\thmlopatch@endchapter\protect\thmlopatch@chapter{\thechapter}}}
%  {}{failed thmtlo@chaptervspacehack}
%\AtEndDocument{\addtocontents{loe}{\protect\thmlopatch@endchapter}}
%\long\def\thmlopatch@chapter#1#2\thmlopatch@endchapter{%
%  \setbox\z@=\vbox{#2}%
%  \ifdim\ht\z@>\z@
%    \hbox{\bfseries\chaptername\ #1}\nobreak
%    #2
%    \addvspace{10\p@}
%  \fi
%}
%\def\thmlopatch@endchapter{}
%\patchcmd\thmt@mklistcmd
%  {\protect\numberline{\csname the\thmt@envname\endcsname}%
%      \thmt@thmname}{}{}{failed thmt@mklistcmd}
%%\makeatother
%\renewcommand\thmtformatoptarg[1]{#1}

% pretty much identical in ltxml, but have to add Verbatim to #1
% \youtubeVideo{youtube code}{actual title}
\newcommand{\youtubeVideo}[2]{\genVideo{#1}{https://youtu.be/#1}{#2}}

\newcommand{\genVideo}[4][]{\exvideo{%
 \begin{minipage}[t]{2cm}%
 \vspace{-.5\baselineskip}\qrcode{#3}%
 \end{minipage}
 \quad
 \begin{minipage}[t]{.74\linewidth}%
  \noindent Watch the video:\\%
  \href{#3#1}{#4 at\\\nolinkurl{#3}}%
 \end{minipage}%
}%
}

\newcommand{\embedVideo}[1]{}
%\def \embedVideo#1{\fbox{%
%  \includemedia[%
%    width=.96\linewidth,%
%    height=0.54\linewidth,% 16:9
%    activate=pageopen,%
%    flashvars={%
%      modestbranding=1% no YT logo in control bar
%     &autohide=1% controlbar autohide
%     &showinfo=0% no title and other info before start
%     &rel=0% no related videos after end
%    }%
%   ]{%
%    %\href{https://www.youtube.com/v/#1?rel=0}{#1}% alt text
%   }{%
%    #1%https://www.youtube.com/v/#1?rel=0%
%   }%
%}}

% only in .ltxml
\newcommand{\iframe}[3]{}
\newcommand{\makeStyles}[2]{}
\newcommand{\lxIncludeJavascriptFile}[1]{}
\newcommand{\lxIncludeCssFile}[1]{}
\newcommand{\showans}[1]{}

\newcommand{\coloredbox}[3]{%
\noindent%
\begin{tikzpicture}%
\ifthenelse{\boolean{inColor}}%
{\draw (0,0) node[#1] {#3};}% was (\specialboxtitlelength,0)
{\draw (0,0) node[#2] {#3};}% ditto
\end{tikzpicture}%
}


%%%%%%%%% the line to the left of examples

% creates a generic style for the lines. You can add lots
% of things here, all separated by commas.
%\newcommand{\linestyle}{[thick, \thelinecolor]}

%\newcommand{\setlinestyle}[1]{\renewcommand{\linestyle}{[#1, \thelinecolor]}}

% Do you want to draw the blue lines for examples?
\newboolean{showexamplelines}
\setboolean{showexamplelines}{true}
%\setboolean{showexamplelines}{false}

%\newcommand*{\currentExampleLabel}{\undefined}

\newboolean{eoeencountered}
\newcommand{\currentLabel}{notinexample}

%% thanks to Steven B. Segletes and egreg at
%% http://tex.stackexchange.com/a/320586/107497
%\newcommand{\eoehere}{%
% \ifthenelse{\boolean{eoeencountered}}{%
%  \vspace{-\baselineskip}\nopagebreak%
% }{%
%  \drawnode{e\currentLabel}{0}{0}%
%  \ltx@label{e\currentLabel}%
% % \gdef\currentLabel{notinexample}%
%  \ifthenelse{\boolean{measuring@}}{}{\global\eoeencounteredtrue}%
% }%
%}

%\newcounter{pagebeforeend}

%\newcommand{\examplestarred}[3]{%
%%\stepcounter{examplecounter}%
%\setboolean{eoeencountered}{false}%
%\renewcommand{\currentLabel}{#1}%
%\bigbreak%
%\noindent%
%\begin{exampleEnv}[#2]\label{#1}%
% \drawnode{#1}{-2\marginlinelength}{\baselineskip}%
% \ifthenelse{\pageref{#1}=\pageref{e#1}}{}{%
%  % if different pages, we need to draw start to bottom before leaving the page
%  \ifthenelse{\boolean{showexamplelines}}{%
%   \begin{tikzpicture}[remember picture,overlay]%
%    \node [yshift=\bottommarginlength](bottom) at (current page.north) {};%
%    \draw [thick, \thelinecolor] (#1) -- ( #1 |- bottom);% from start to bottom of page
%   \end{tikzpicture}%
%  }{}%
% }%
% \noindent%
% #3%
% \eoehere%
% \ifthenelse{\boolean{showexamplelines}}{%
%  \ifthenelse{\pageref{#1}=\pageref{e#1}}{%
%   \begin{tikzpicture}[remember picture,overlay]
%    \drawexampleend{#1}{#1}
%   \end{tikzpicture}%
%  }{% if different pages (start to bottom already happened)
%   \ifthenelse{\isodd{\pageref{e#1}}}{%
%    \setlength{\innerpagemarginlength}{\oddpagemarginlength}%
%   }{%
%    \setlength{\innerpagemarginlength}{\evenpagemarginlength}%
%   }%
%   \begin{tikzpicture}[remember picture,overlay]
%    \node [xshift=\innerpagemarginlength,yshift=\topmarginlength](topleft) at (current page.north west)  {};
%    \drawexampleend{topleft}{#1}
%   \end{tikzpicture}%
%  }
% }{}% ends if example lines
%\end{exampleEnv}%
%\bigbreak%
%}%ends the definition of examplestarred

%\newcommand*{\drawexampleend}[2]{%
% \draw [thick, \thelinecolor] (#1)--(#1 |- e#2.south) -- ++(0,-.2\baselineskip) -- ++(10pt,0);
%}
%
%\newcommand*{\drawnode}[3]{%
%\parbox[l]{0pt}{%
% \ifthenelse{\boolean{showexamplelines}}{%
%  \begin{tikzpicture}[remember picture,overlay]
%   \draw (#2,#3) node (#1) {};
%%   \draw (#2,#3) circle (1pt) node (#1) {};
%%   \draw (#2,#3) circle (1pt) node (#1) {\nolinkurl{#1}};
%  \end{tikzpicture}%
% }{}%
%}}
%
%\AddEverypageHook{%
% \ifthenelse{ \pageref{\currentLabel}<\value{page} \AND
%              \value{page}<\pageref{e\currentLabel} %\AND
%              %\boolean{@mainmatter} \AND \boolean{printquestions}
%               }{%
%  \drawexampleline%
% }{}%
%}%


%% Draws a line on a page that doesn't contain either
%% the beginning or end of an example.
%% Takes no arguments; figures out if you 
%% are on an even or odd numbered page for
%% correct margin calculation
%\newcommand{\drawexampleline}{%
%\ifthenelse{\isodd{\thepage}}{%
% \setlength{\innerpagemarginlength}{\oddpagemarginlength}%
%}{%
% \setlength{\innerpagemarginlength}{\evenpagemarginlength}%
%}%
%\begin{tikzpicture}[remember picture,overlay]
%	\node [xshift=\innerpagemarginlength,yshift=\topmarginlength](tleft) at (current page.north west)  {};
%	\draw [thick, \thelinecolor] (tleft) -- ++(0,\bottommarginlength+1in);
%\end{tikzpicture}}


\newcommand{\previousmarginpage}{-1}
\newlength\previousmarginbottom

% thanks to David Carlisle at http://tex.stackexchange.com/a/336910/107497
% the height cut offs have been empirically determined
\newcommand{\testmargintop}{%
	\strut\pdfsavepos%
	\write\@auxout{\string\testmargintopwith{\the\pdflastxpos}{\the\pdflastypos}{\thepage}}%
}
\newcommand{\testmargintopwith}[3]{%
%\PackageInfo{apex}{test margin top with on page #3: #2}%
	\ifthenelse{ #2 > 46800000 }{% 468e5
		\PackageWarningNoLine{apex}{mnote too high on page #3}%
	}{}%
	\ifthenelse{ #1 < 0 }{%
		\PackageWarningNoLine{apex}{mnote on left inner margin on page #3}%
	}{}%
	\ifthenelse{ #1 > 33000000 }{% 33e6
		\PackageWarningNoLine{apex}{mnote on right inner margin on page #3}% {: #1}%
	}{}%
	\ifthenelse{ #3 = \previousmarginpage }{%
		\ifthenelse{\lengthtest{\previousmarginbottom < #2 sp}}{%
			\PackageWarningNoLine{apex}{mnote overlaps on page #3}% {: #2}%
		}{\addtolength{\previousmarginbottom}{-2\baselineskip}%
			\ifthenelse{\lengthtest{\previousmarginbottom < #2 sp}}{%
				\PackageInfo{apex}{mnote close on page #3 (ignore line no)}%
			}{}%
		}%
	}{}%
	\global\renewcommand{\previousmarginpage}{#3}%
}
\newcommand{\testmarginbottom}{%
	\strut\pdfsavepos%
	\write\@auxout{\string\testmarginbottomwith{\the\pdflastypos}{\thepage}}%
}
\newcommand{\testmarginbottomwith}[2]{%
%\PackageInfo{apex}{testmarginbottomwith on page #2: #1}%
	\ifthenelse{ #1 < 2700000 }{% 27e5
		\PackageWarningNoLine{apex}{mnote too low on page #2}%
	}{%
		\ifthenelse{ #1 < 10000000 }{% 1e7
			\PackageInfo{apex}{mnote below Notes line on page #2 (ignore line no)}%
		}{}%
	}%
%\PackageInfo{apex}{on page #2: setting pmb to: #1}%
	\global\setlength{\previousmarginbottom}{#1 sp}%
	% 1 in = 72 pt ; 1 pt = 65536 sp = 2^16 sp
}
% I think these make it so that compiling without this file won't fail
\write\@auxout{%
 \string\providecommand{\string\testmargintopwith}[3]{}%
}
\write\@auxout{%
 \string\providecommand{\string\testmarginbottomwith}[2]{}%
}
\AtEndDocument{\stoptestingmargins}
\newcommand{\stoptestingmargins}{%
	\renewcommand{\testmargintopwith}[2]{}%
	\renewcommand{\testmarginbottomwith}[2]{}%
}


% I need to do this for the next part
% the group is so that the catcode redefinition is local
\begingroup
\catcode`\#=12
\gdef\@hashchar{#}%
\endgroup

\newcommand{\prc@autoref}{%
 \ifthenelse{\boolean{printquestions}}{% not in solutions
  \ifthenelse{\equal{\Itemautorefname}{item}}{% not in exercises
   % therefore, regular text
   \stepcounter{figure}%
   Figure \thefigure%
   \addtocounter{figure}{-1}%
  }{% else in exercises
   \thesection\@hashchar\arabic{enumi}%
  }%
 }{% else in solutions
  \theanswersection\@hashchar\arabic{enumi}%
 }%
}

\newcommand{\prc@section@autoref}{%
 \ifthenelse{\boolean{printquestions}}{% not in solutions
  Section \thesection%
 }{% else in solutions
  Section A.\theanswerchapter%
 }%
}

\newcommand{\myincludeasythree}[3]{%
 % we want a library of 3d images
 % each call here also leaves a marker in the aux file, which Python can then find
 % this works if the above are etoolbox's ifthenelse, but not ifthen's
 % e.g.: \typeout{find me \ifthenelse{\boolean{true}}{a}{b}}
% \immediate\write\@auxout{%
%  \@percentchar\space prc file #3 used in \prc@section@autoref\space as \prc@autoref%
% }%
 \ifthenelse{\boolean{printquestions}}{% not in solutions
  \ifthenelse{\equal{\Itemautorefname}{item}}{% not in exercises
   % therefore, regular text
   \stepcounter{figure}%
   \immediate\write\@auxout{%
    \@percentchar\space prc file #3 used in Section \thesection\space as Figure \thefigure%
   }%
   \addtocounter{figure}{-1}%
  }{% else in exercises
   \immediate\write\@auxout{%
    \@percentchar\space prc file #3 used in Section \thesection\space as \thesection\@hashchar\arabic{enumi}%
   }%
  }%
 }{% else in solutions
  \immediate\write\@auxout{%
   \@percentchar\space prc file #3 used in Section A.\thechapter\space as \thesection\@hashchar\arabic{enumi}%
%   \@percentchar\space prc file #3 used in Section A.\theanswerchapter\space as \theanswersection\@hashchar\arabic{enumi}%
  }%
 }%
 \ifthenelse{\boolean{in_threeD}}{%
  \includemedia[3Dmenu,activate=onclick,deactivate=onclick,3Dlights=Headlamp,
   add3Djscript=asylabels.js,#1
  ]{\myincludegraphics{#3}}{#3\colornamesuffix.prc}%
 }{%
  \myincludegraphics[#2]{#3}%
 }%
}

\newcommand{\myincludegraphicsthree}{\@ifstar \myincludegraphicsthreestarred \myincludegraphicsthreenostar}

\newcommand{\myincludegraphicsthreenostar}[3]{\ifthenelse{\boolean{in_threeD}}{%
	\includemedia[#1]{\myincludegraphics{#3_3D}}{#3_3D.prc}%
}{%
	\myincludegraphics[#2]{#3}
}}

\newcommand{\myincludegraphicsthreestarred}[3]{\ifthenelse{\boolean{in_threeD}}{%
	\includemedia[#1]{\myincludegraphics{#3}}{#3_3D.prc}%
}{%
	\myincludegraphics[#2]{#3}
}}



\newcounter{flushcounter}
\newcommand{\flushinner}[1]{%
	\stepcounter{flushcounter}%
	\makebox[0pt]{\label{flushlabel\theflushcounter}}%
	\ifthenelse{\boolean{latexml}\OR\isodd{\pageref{flushlabel\theflushcounter}}}{%
%		\makebox[.99\linewidth][l]{#1}%
%		\makebox[.99\linewidth][l]{\parbox{.99\linewidth}{#1}}%
		\makebox[.99\linewidth][l]{\begin{tabular}{c}#1\end{tabular}}%
}{%
%		\makebox[.99\linewidth][r]{#1}%
%		\makebox[.99\linewidth][r]{\parbox{\textwidth}{#1}}%
		\makebox[.99\linewidth][r]{\begin{tabular}{c}#1\end{tabular}}%
	}}
\newcommand{\flushouter}[1]{%
	\stepcounter{flushcounter}%
	\makebox[0pt]{\label{flushlabel\theflushcounter}}%
	\ifthenelse{\boolean{latexml}\OR\isodd{\pageref{flushlabel\theflushcounter}}}{%
		\makebox[.99\linewidth][r]{\begin{tabular}{c}#1\end{tabular}}%
	}{%
		\makebox[.99\linewidth][l]{\begin{tabular}{c}#1\end{tabular}}%
	}}
\newcommand{\flushinnerequ}[1]{\flushinner{\vtop{#1}}}
\newcommand{\flushouterequ}[1]{\flushouter{\vtop{#1}}}


\newcommand*{\includecodegraphics}[1]{\input{#1Src}}

\newcommand*{\lxenumerate}[1]{\begin{enumerate}[#1]}


% this has been annoying
% I want the document to go: #.0, chap title, chap intro, #.1
% I want the TOC to omit the #.0
% I want the pdf bookmarks to keep #.0
% I tried to have a \pdfbookmark to the prerequisite section filed under the chapter,
% but the link was out of order, so it doesn't work
% instead, we'll go with:
% [pdfbookmark]chap title, #.0, [toc]chap title, [pdfbookmark]chap intro, #.1
\newcommand*{\apexchapter}[3][]{%
 \setcounter{figure}{0}% in case there are figures before the first section
 \clearpage\thispagestyle{empty}\cleardoublepage%
% \setboolean{chapter_already_has_exercises}{false}%
 \ifthenelse{\equal{#1}{}}{% no prereq section
  \chapter{#2}\label{#3}%
 }{% else, there is a #1 argument
  \refstepcounter{chapter}%
  \pdfbookmark[chapter]{\thechapter\ #2}{#3}
  \addtocounter{section}{-1}%
  \fancyhead[LE]{\chaptername\ \thechapter\ \ \ \ {#2}}%
  \bgroup
   \renewcommand{\addcontentsline}[3]{}%
   \let\oldsection=\section
   \renewcommand{\section}[1]{%
    \oldsection{##1}
    \label{prereq#3}
    \pdfbookmark[section]{\thesection\ ##1}{prereq#3}
   }
   \input{#1}%
  \egroup
  \restoregeometry
  % the grouping intercepted the restoregeometry at the end of the prereq's exercises
  \fancyhead[LE]{\nouppercase{\leftmark}}%
  \chapter*{\thechapter: #2}\label{#3}
%  \thispagestyle{fancy}%
  \hypersetup{bookmarksdepth=-2}% make the next line not appear in the pdf bookmarks
  \addcontentsline{toc}{chapter}{\string\numberline{\arabic{chapter}}#2}
  \hypersetup{bookmarksdepth=2}
  \pdfbookmark[section]{Chapter Introduction}{#3}
  \fancyhead[LE]{\chaptername\ \thechapter\ \ \ \ {#2}}%
 }%
 \thispagestyle{fancy}%
}



% some exercise / answer related commands

%\newcommand{\writeToAnsFile}[1]{%
% \immediate\write\answrite{%
%  \noexpand\answersForSection{\arabic{chapter}}{\arabic{section}}{#1}%
% }%
%}
